# SoW：SkillGate 要件定義・設計・実装

## 0. 文書管理
- 文書名：SkillGate Statement of Work（SoW）兼 要件定義書  
- 版：v1.0  
- 作成日：2026-02-02（Europe/London）  
- 作成者：依頼者／開発者（共同）  
- 想定読者：依頼者、開発担当、セキュリティレビュー担当

---

## 1. 目的（Purpose）
本SoWは、公開リポジトリ／レジストリから取得される「skill（エージェント拡張・プラグイン・MCPサーバ等を含む実行可能拡張）」について、**導入（install/enable）前のセキュリティ評価・強制（enforcement）**を行うシステム「SkillGate」の開発範囲、成果物、受入基準、スケジュール、責任分界を定義する。

---

## 2. 背景（Background）
- AIエージェントの拡張（skill）が急増し、skillは「設定ファイル」ではなく**ローカル環境で実行されるコード・依存関係・操作手順**を含むことが多い。
- 利用者のローカル環境には APIキー、SSH鍵、ブラウザ資格情報、.env 等が存在し、skill導入はサプライチェーン攻撃／情報窃取の主要ベクトルとなり得る。
- 既存の静的解析や依存関係スキャンは点で存在するが、導入プロセスに**強制力（gate）として組み込まれていない**ことが多い。

---

## 3. 目標（Objectives）
SkillGateは以下を達成する：

1. **導入前検査（Pre-install Audit）**：指定されたskillソース（Git URL、アーカイブ、レジストリURL等）を取得・正規化し、多層スキャンでリスク評価を行う。  
2. **強制（Enforcement）**：評価結果とポリシーに基づき、導入を「許可／ブロック／隔離実行（サンドボックス）／権限制限で許可」に分岐する。  
3. **監査可能性（Auditability）**：判定根拠（証跡）を機械可読（JSON）＋人間可読（HTML/Markdown）で出力し、再現性を担保する。  
4. **統合容易性（Integrability）**：CLI/RESTで提供し、エージェント本体・CI/CD・レジストリ運用に組み込み可能にする。  
5. **安全なデフォルト（Secure by Default）**：最小権限、危険挙動の事前検知、実行隔離を基本方針とする。

---

## 4. スコープ（Scope）

### 4.1 In Scope（実施範囲）

#### A. 対象入力（Skill Source）
- Git URL（例：GitHub上の公開repo）
- ローカルアーカイブ（zip/tar.gz）
- レジストリURL（将来拡張：特定マーケットのAPI連携）

#### B. 検査（Audit）機能
- ソース取得・固定化（コミットSHA／タグ固定、ハッシュ算出）
- 署名・来歴（任意）：署名付きタグ、SBOM、provenance、attestationの検証（可能な範囲）
- Secret検出（漏えい鍵、トークン、資格情報の混入）
- 依存関係解析（ロックファイル、依存ツリー、既知脆弱性）
- 静的解析（危険API、任意コマンド実行、ダウンローダ、難読化の兆候）
- 実行導線検出（install script、postinstall、Makefile、curl|bash 等）
- CI設定リスク（ワークフロー内の危険権限、外部取得、シークレット露出の可能性）
- 供給元健全性（リポジトリ運用指標：ブランチ保護、リリース、セキュリティポリシー等）
  - 参考：OpenSSF Scorecard相当の観点

#### C. ポリシー判定（Policy Engine）
- ルール：MUST/SHOULD/MAY による評価基準
- 出力：Risk Score（0–100）＋Severity（Low/Med/High/Critical）＋理由
- 運用：policy-as-code（YAML/JSON等）でルール更新可能

#### D. 強制（Enforcement / Gate）
- ブロック（install/enable 不可）
- 条件付き許可（例：ネットワーク遮断、read-only FS、環境変数マスキング等）
- 隔離実行（サンドボックスでのドライラン、挙動確認）
- 許可（証跡付き）

#### E. 出力（Reports）
- JSON（機械可読：CI連携用）
- Markdown/HTML（人間可読：レビュー用）
- 証跡（ハッシュ、コミット、検出結果、ルール発火一覧）

#### F. 提供形態（Interfaces）
- CLI（ローカル導入ゲート）
- REST API（他システム統合向け）
- Exit code（CI/CD での成功/失敗判定）

---

### 4.2 Out of Scope（除外範囲）
- 侵入テスト代行、マルウェア解析レポートの個別作成（ただし検知ロジック改善のための最小限の解析は可）
- 100%の安全保証（本質的に不可能。リスク低減を目的とする）
- 特定ベンダーの商用スキャナ連携（要望があれば変更管理で追加）
- レジストリ運営側のKYC/審査プロセス構築（SkillGateはクライアント側ゲートが主）

---

## 5. 要件（Requirements）

### 5.1 機能要件（Functional Requirements）

#### FR-01 取得・固定化
- MUST：入力ソースを取得し、内容のハッシュ（SHA-256等）を算出する  
- MUST：Gitの場合、デフォルトでコミットSHAを記録し、再現可能にする  
- SHOULD：タグ／リリース利用時、署名付きタグ検証（可能なら）を行う  

#### FR-02 正規化（Normalization）
- MUST：主要言語の依存定義（package-lock / yarn.lock / requirements / go.mod / Cargo.lock 等）を検出し、内部の共通スキーマに変換する  

#### FR-03 Secret検出
- MUST：リポジトリ全体を対象にsecretスキャンを行い、種類・ファイルパス・行情報を報告する  
- MUST：レポート出力時、秘密情報そのものをマスクする（証跡に残さない）  

#### FR-04 依存関係リスク
- MUST：既知脆弱性（OSV/NVD等のDBを想定）の照合結果を出す  
- SHOULD：依存のインストールスクリプトやバイナリ同梱の兆候を追加評価する  

#### FR-05 静的解析
- MUST：危険操作（任意コマンド、外部DL実行、資格情報探索、永続化）に関するルールを提供  
- SHOULD：難読化（base64連鎖、文字列分割、長大ワンライナー等）を検知して加点  

#### FR-06 実行導線検出
- MUST：インストール時に自動実行され得るポイント（postinstall、setup.py、Makefileターゲット等）を列挙  
- MUST：`curl|bash` / `wget|sh` 等の危険パターンをCritical扱い可能にする  

#### FR-07 供給元健全性
- SHOULD：リポジトリの基本的な保護状況を評価（ブランチ保護、リリース、セキュリティポリシー等）  

#### FR-08 ポリシー判定
- MUST：検査結果→ルール評価→スコア／判定を一意に算出  
- MUST：判定根拠（どのルールが発火したか）を出力  

#### FR-09 強制
- MUST：CLIで `allow / block / quarantine` を返す（exit code含む）  
- SHOULD：隔離環境でのドライラン（ネットワーク遮断、read-only等）を実装可能な設計にする  

#### FR-10 統合
- MUST：JSON出力でCIに組み込みやすくする  
- SHOULD：REST APIで外部呼び出し可能にする（認証必須）  

---

### 5.2 非機能要件（Non-Functional Requirements）

#### NFR-01 セキュリティ
- MUST：SkillGate自身は最小権限で動作（root不要を原則）  
- MUST：レポート・ログに秘密情報を保存しない（マスキング／ハッシュ化）  
- MUST：外部通信は原則オプトイン（必要なDB照会等は明示）  
- SHOULD：自己SBOM生成、依存の固定、署名付きリリース（可能なら）  

#### NFR-02 性能
- MUST：中規模repo（例：10k files以下）で、標準構成にてスキャン完了が現実的（目標：数分オーダー）  
- SHOULD：キャッシュ（同一コミット再スキャン回避）を提供  

#### NFR-03 可用性
- API提供時は、単一ノード運用を前提に堅牢性を確保（リトライ、タイムアウト、キューイングはMAY）  

#### NFR-04 監査性
- MUST：入力（commit/hash）、設定（policy）、出力（result）がトレース可能  
- MUST：同一入力＋同一policyで同一結果となる（決定性）  

#### NFR-05 保守性
- MUST：ルール追加がコード変更なしでも可能（policy-as-code）  
- SHOULD：プラグイン型でスキャナを差し替え可能  

---

## 6. 想定アーキテクチャ（High-Level Design）
- **Ingestor**：ソース取得、ハッシュ算出、正規化  
- **Scanner Layer**：Secret / Dep / SAST / Metadata / CI-risk 等を並列実行  
- **Policy Engine**：結果を共通スキーマに集約し、ルール評価・スコア算出  
- **Enforcer**：allow/block/quarantine を返す（必要に応じて隔離環境を起動）  
- **Reporter**：JSON＋Markdown/HTML 出力、証跡付与  
- **Interfaces**：CLI / REST（任意）  

---

## 7. 成果物（Deliverables）
1. 要件定義（本書）最終版  
2. アーキテクチャ設計書（データフロー、信頼境界、脅威モデル含む）  
3. MVP実装（CLI + JSON/Markdownレポート + 基本ルールセット）  
4. テスト（ユニット/統合、回帰用サンプル、誤検知/見逃し評価）  
5. 運用ドキュメント（インストール、設定、CI組込例）  
6. セキュリティドキュメント（ログ方針、データ取扱い、更新手順）  

---

## 8. 受入基準（Acceptance Criteria）
- AC-01：指定Git URLを入力してスキャン→判定（allow/block）を返せる  
- AC-02：secret検出・依存脆弱性・危険導線検出がレポートに反映される  
- AC-03：レポートが **秘密情報を露出しない**（マスクされる）  
- AC-04：同一入力（commit/hash）と同一policyで **結果が再現**される  
- AC-05：CIで exit code 判定が可能（block時にジョブ失敗扱いにできる）  
- AC-06：ルール追加がpolicy更新で可能（ドキュメント化されている）  

---

## 9. マイルストーン（Milestones）
> 期間は目安。週数は稼働量に合わせて調整。

1. Phase 0：キックオフ／対象skill形態の確定（1週）  
2. Phase 1：要件確定・脅威モデル・設計（1–2週）  
3. Phase 2：MVP実装（2–4週）  
4. Phase 3：評価（悪性サンプル・正常サンプルでの精度測定）、改善（2週）  
5. Phase 4：ドキュメント整備・リリース（1週）  

---

## 10. 役割分担（Roles & Responsibilities）
- 依頼者：ユースケース提供、優先順位付け、受入判定、評価用サンプル提供（可能な範囲）  
- 開発者：設計、実装、テスト、ドキュメント作成、脆弱性対応フロー整備  
- セキュリティレビュー（任意）：脅威モデルレビュー、ルール妥当性レビュー  

---

## 11. 前提条件・依存（Assumptions & Dependencies）
- ローカル実行環境：macOS/Linux（優先）  
- コンテナ/隔離：Docker等が利用可能（隔離実行を採用する場合）  
- 外部DB照会：ネットワークアクセスが許可される（オフラインモードも検討可）  
- 大規模レジストリ連携は、API仕様・利用規約に依存  

---

## 12. 変更管理（Change Control）
- 仕様変更は「変更要求（CR）」として起票し、影響範囲（工数・納期・リスク）を明記して合意後に反映  
- ルールセット更新は、原則として後方互換性とバージョニングを持つ  

---

## 13. リスクと対策（Risks & Mitigations）
- R-01：誤検知で業務妨害 → severity別の例外ルール、検知根拠の透明化  
- R-02：見逃しで侵害 → 多層防御（Secret/Dep/SAST/導線/署名/隔離）＋継続更新  
- R-03：攻撃者の回避（難読化・分割） → ルールとヒューリスティックの継続改善  
- R-04：レジストリ仕様変更 → REST/アダプタ層で吸収  

---

## 14. 付録：用語（Glossary）
- skill：エージェント拡張（コード・設定・依存・実行手順を含む）  
- enforcement：導入可否を強制するゲート動作  
- quarantine：隔離実行／制限付き許可  
- policy-as-code：ポリシーを設定ファイルで管理し、コード変更なく更新可能にする方式  

